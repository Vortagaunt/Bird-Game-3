<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird Game 3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            overflow: hidden;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
            image-rendering: pixelated;
        }

        #hud {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            font-size: 16px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border: 2px solid #666;
            display: none;
        }

        #victoryScreen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffd700;
            font-size: 64px;
            text-shadow: 4px 4px 0 #000;
            display: none;
            text-align: center;
            z-index: 200;
            background: rgba(0, 0, 0, 0.9);
            padding: 60px;
            border: 4px solid #ffd700;
        }

        #victoryScreen .subtitle {
            font-size: 24px;
            color: #fff;
            margin-top: 20px;
        }

        #victoryScreen .nextButton {
            font-size: 28px;
            color: #00ff00;
            margin-top: 40px;
            padding: 15px 30px;
            border: 3px solid #00ff00;
            display: inline-block;
            cursor: pointer;
            animation: blink 1s infinite;
        }

        #gameOver {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff0000;
            font-size: 48px;
            text-shadow: 4px 4px 0 #000;
            display: none;
            text-align: center;
            z-index: 200;
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border: 4px solid #ff0000;
        }

        #instructions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            font-size: 14px;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border: 2px solid #666;
            display: none;
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                transparent 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 1000;
        }

        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        #mainMenu h1 {
            color: #00ff00;
            font-size: 72px;
            text-shadow: 4px 4px 0 #000;
            margin-bottom: 20px;
            letter-spacing: 8px;
        }

        #mainMenu .subtitle {
            color: #ffff00;
            font-size: 24px;
            text-shadow: 2px 2px 0 #000;
            margin-bottom: 60px;
        }

        #mainMenu .startButton {
            color: #fff;
            font-size: 32px;
            text-shadow: 3px 3px 0 #000;
            padding: 20px 40px;
            border: 4px solid #fff;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        #mainMenu .controls {
            position: absolute;
            bottom: 60px;
            color: #aaa;
            font-size: 16px;
            text-shadow: 2px 2px 0 #000;
            text-align: center;
            line-height: 1.8;
        }

        #customizationMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        #customizationMenu h2 {
            color: #00ff00;
            font-size: 48px;
            text-shadow: 3px 3px 0 #000;
            margin-bottom: 40px;
        }

        .customization-section {
            margin: 30px 0;
            text-align: center;
        }

        .customization-section h3 {
            color: #ffff00;
            font-size: 24px;
            text-shadow: 2px 2px 0 #000;
            margin-bottom: 20px;
        }

        .option-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .option-button {
            padding: 15px 25px;
            border: 3px solid #666;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 18px;
            text-shadow: 2px 2px 0 #000;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.2s;
        }

        .option-button:hover {
            border-color: #fff;
            background: rgba(255, 255, 255, 0.2);
        }

        .option-button.selected {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        .color-option {
            width: 80px;
            height: 80px;
            border: 3px solid #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-option:hover {
            border-color: #fff;
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #00ff00;
            border-width: 5px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.7);
        }

        #startGameButton {
            margin-top: 50px;
            padding: 20px 50px;
            border: 4px solid #00ff00;
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            font-size: 28px;
            text-shadow: 2px 2px 0 #000;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <div id="mainMenu">
        <h1>BIRD GAME 3</h1>
        <div class="subtitle">PS1 EDITION</div>
        <div class="startButton">PRESS ENTER TO START</div>
        <div class="controls">
            WASD/ARROWS: Move | SPACE: Up | SHIFT: Down<br>
            Hit birds to kill them | Don't let birds hit you
        </div>
    </div>

    <div id="customizationMenu">
        <h2>CUSTOMIZE YOUR BIRD</h2>
        
        <div class="customization-section">
            <h3>SELECT COLOR</h3>
            <div class="option-grid">
                <div class="color-option selected" style="background: #ff0000;" data-color="0xff0000"></div>
                <div class="color-option" style="background: #00ff00;" data-color="0x00ff00"></div>
                <div class="color-option" style="background: #0000ff;" data-color="0x0000ff"></div>
                <div class="color-option" style="background: #ffff00;" data-color="0xffff00"></div>
                <div class="color-option" style="background: #ff00ff;" data-color="0xff00ff"></div>
                <div class="color-option" style="background: #00ffff;" data-color="0x00ffff"></div>
                <div class="color-option" style="background: #ff8800;" data-color="0xff8800"></div>
                <div class="color-option" style="background: #ffffff;" data-color="0xffffff"></div>
            </div>
        </div>

        <div class="customization-section">
            <h3>SELECT SHAPE</h3>
            <div class="option-grid">
                <div class="option-button selected" data-shape="balanced">BALANCED</div>
                <div class="option-button" data-shape="chonky">CHONKY</div>
                <div class="option-button" data-shape="speedy">SPEEDY</div>
                <div class="option-button" data-shape="tiny">TINY</div>
                <div class="option-button" data-shape="long">LONG NECK</div>
                <div class="option-button" data-shape="thicc">THICC WINGS</div>
            </div>
        </div>

        <button id="startGameButton">START GAME</button>
    </div>

    <div id="hud">
        <div>LEVEL: <span id="levelCount">1</span></div>
        <div>BIOME: <span id="biomeDisplay">GRASSLAND</span></div>
        <div>BIRDS ALIVE: <span id="birdCount">10</span></div>
        <div>STATUS: <span id="status">FLYING</span></div>
    </div>
    
    <div id="victoryScreen">
        <div>VICTORY ROYALE!</div>
        <div class="subtitle">ALL BIRDS ELIMINATED</div>
        <div class="nextButton" onclick="nextLevel()">PRESS N FOR NEXT LEVEL</div>
    </div>
    
    <div id="gameOver">
        <div>GAME OVER</div>
        <div style="font-size: 20px; margin-top: 20px;">PRESS R TO RESTART</div>
    </div>

    <div id="instructions">
        WASD/ARROWS: Move | SPACE: Up | SHIFT: Down | Avoid other birds!
    </div>

    <div class="scanline"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // PS1 Style Bird Game
        let scene, camera, renderer;
        let player;
        let birds = [];
        let keys = {};
        let gameActive = false;
        let gameStarted = false;
        let currentLevel = 1;
        let playerColor = 0xff0000;
        let playerShape = 'balanced';
        let ground;

        // Biome definitions
        const biomes = [
            { name: 'GRASSLAND', ground: 0x4a7c3c, sky: 0x87ceeb, fog: 0x87ceeb },
            { name: 'DESERT', ground: 0xc2b280, sky: 0xffd89b, fog: 0xffd89b },
            { name: 'SNOW', ground: 0xe0f0ff, sky: 0xb0c4de, fog: 0xb0c4de },
            { name: 'LAVA', ground: 0x8b0000, sky: 0xff4500, fog: 0xff4500 },
            { name: 'OCEAN', ground: 0x1e90ff, sky: 0x4682b4, fog: 0x4682b4 },
            { name: 'ALIEN', ground: 0x9b4dca, sky: 0x6b2c8a, fog: 0x6b2c8a },
            { name: 'AUTUMN', ground: 0xa0522d, sky: 0xffa07a, fog: 0xffa07a },
            { name: 'TOXIC', ground: 0x7fff00, sky: 0x9acd32, fog: 0x9acd32 },
            { name: 'MIDNIGHT', ground: 0x191970, sky: 0x000033, fog: 0x000033 },
            { name: 'CANDY', ground: 0xff69b4, sky: 0xffb6c1, fog: 0xffb6c1 }
        ];

        function getCurrentBiome() {
            return biomes[(currentLevel - 1) % biomes.length];
        }

        // PS1 rendering settings
        const RENDER_SCALE = 0.6; // Lower resolution for PS1 effect
        const VERTEX_JITTER = 0.02; // Vertex wobble amount

        // Game settings - scale with level
        function getBirdCount() {
            return 8 + (currentLevel * 3); // Start with 8, add 3 per level
        }
        
        function getBirdSpeed() {
            return 0.06 + (currentLevel * 0.02); // Increase speed per level
        }
        
        const MOVE_SPEED = 0.15;
        const COLLISION_DISTANCE = 2.5;

        function init() {
            // Scene
            scene = new THREE.Scene();
            const biome = getCurrentBiome();
            scene.fog = new THREE.Fog(biome.fog, 10, 80);
            scene.background = new THREE.Color(biome.sky);

            // Camera
            camera = new THREE.PerspectiveCamera(
                60,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 8, 15);
            camera.lookAt(0, 0, 0);

            // Renderer with PS1 settings
            renderer = new THREE.WebGLRenderer({ 
                antialias: false, // No antialiasing for PS1 look
                canvas: document.createElement('canvas')
            });
            
            const width = Math.floor(window.innerWidth * RENDER_SCALE);
            const height = Math.floor(window.innerHeight * RENDER_SCALE);
            
            renderer.setSize(width, height, false);
            renderer.shadowMap.enabled = false; // Disable shadows for performance
            
            // Create a canvas for displaying
            const displayCanvas = document.createElement('canvas');
            displayCanvas.id = 'gameCanvas';
            document.body.appendChild(displayCanvas);
            const ctx = displayCanvas.getContext('2d');
            displayCanvas.width = window.innerWidth;
            displayCanvas.height = window.innerHeight;
            
            // Render loop will copy with pixelation
            renderer.domElement.style.imageRendering = 'pixelated';

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffcc, 0.8);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);

            // Ground plane
            const groundGeometry = new THREE.PlaneGeometry(100, 100, 10, 10);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: biome.ground,
                flatShading: true
            });
            ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -2;
            scene.add(ground);

            // Add vertex jitter to ground
            addVertexJitter(groundGeometry);

            // Create player bird
            player = createBird(playerColor, 0, 0, 0, true);
            player.isPlayer = true;
            scene.add(player);

            // Create AI birds with varied colors
            const birdCount = getBirdCount();
            for (let i = 0; i < birdCount; i++) {
                const x = (Math.random() - 0.5) * 40;
                const y = Math.random() * 10 - 2;
                const z = (Math.random() - 0.5) * 40;
                
                // More varied colors
                const colors = [
                    0x0000ff, 0x00ffff, 0x00ff00, 0xffff00, 
                    0xff00ff, 0xff8800, 0x8800ff, 0x00ff88
                ];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                const bird = createBird(color, x, y, z, false);
                const speed = getBirdSpeed();
                bird.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * speed,
                    (Math.random() - 0.5) * speed * 0.5,
                    (Math.random() - 0.5) * speed
                );
                birds.push(bird);
                scene.add(bird);
            }

            // Input handling
            window.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
                
                if (e.key === 'Enter' && !gameStarted) {
                    showCustomization();
                }
                
                if (e.key.toLowerCase() === 'n' && document.getElementById('victoryScreen').style.display === 'block') {
                    nextLevel();
                }
                
                if (e.key.toLowerCase() === 'r' && !gameActive && gameStarted) {
                    restartGame();
                }
            });
            window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

            // Customization menu handlers
            setupCustomizationHandlers();

            // Handle window resize
            window.addEventListener('resize', onWindowResize);

            // Start animation
            animate(displayCanvas, ctx);
        }

        function createBird(color, x, y, z, isPlayer = false) {
            const bird = new THREE.Group();

            // Define shape presets
            let bodyScaleX, bodyScaleY, bodyScaleZ, headSize, wingLength, wingThickness, neckLength, bodySegments;
            
            if (isPlayer) {
                // Use player's selected shape
                switch(playerShape) {
                    case 'balanced':
                        bodyScaleX = 1;
                        bodyScaleY = 0.8;
                        bodyScaleZ = 1.5;
                        headSize = 0.6;
                        wingLength = 2;
                        wingThickness = 0.3;
                        neckLength = 0;
                        bodySegments = 6;
                        break;
                    case 'chonky':
                        bodyScaleX = 1.4;
                        bodyScaleY = 1.2;
                        bodyScaleZ = 1.3;
                        headSize = 0.7;
                        wingLength = 1.5;
                        wingThickness = 0.5;
                        neckLength = 0;
                        bodySegments = 5;
                        break;
                    case 'speedy':
                        bodyScaleX = 0.7;
                        bodyScaleY = 0.6;
                        bodyScaleZ = 2;
                        headSize = 0.4;
                        wingLength = 2.5;
                        wingThickness = 0.2;
                        neckLength = 0;
                        bodySegments = 7;
                        break;
                    case 'tiny':
                        bodyScaleX = 0.6;
                        bodyScaleY = 0.5;
                        bodyScaleZ = 0.8;
                        headSize = 0.4;
                        wingLength = 1.2;
                        wingThickness = 0.2;
                        neckLength = 0;
                        bodySegments = 4;
                        break;
                    case 'long':
                        bodyScaleX = 0.8;
                        bodyScaleY = 0.7;
                        bodyScaleZ = 1.2;
                        headSize = 0.5;
                        wingLength = 1.8;
                        wingThickness = 0.3;
                        neckLength = 0.8;
                        bodySegments = 6;
                        break;
                    case 'thicc':
                        bodyScaleX = 1;
                        bodyScaleY = 0.9;
                        bodyScaleZ = 1.4;
                        headSize = 0.6;
                        wingLength = 2.8;
                        wingThickness = 0.6;
                        neckLength = 0;
                        bodySegments = 6;
                        break;
                    default:
                        bodyScaleX = 1;
                        bodyScaleY = 0.8;
                        bodyScaleZ = 1.5;
                        headSize = 0.6;
                        wingLength = 2;
                        wingThickness = 0.3;
                        neckLength = 0;
                        bodySegments = 6;
                }
            } else {
                // Randomize for AI birds
                bodyScaleX = 0.7 + Math.random() * 0.6;
                bodyScaleY = 0.6 + Math.random() * 0.4;
                bodyScaleZ = 1.2 + Math.random() * 0.8;
                headSize = 0.4 + Math.random() * 0.4;
                wingLength = 1.5 + Math.random() * 1;
                wingThickness = 0.2 + Math.random() * 0.3;
                neckLength = Math.random() * 0.5;
                bodySegments = Math.floor(4 + Math.random() * 4);
            }
            
            // Body (elongated sphere with random proportions)
            const bodyGeometry = new THREE.SphereGeometry(1, bodySegments, 5);
            const bodyMaterial = new THREE.MeshLambertMaterial({ 
                color: color,
                flatShading: true
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.scale.set(bodyScaleX, bodyScaleY, bodyScaleZ);
            addVertexJitter(bodyGeometry);
            bird.add(body);

            // Head
            const headGeometry = new THREE.SphereGeometry(headSize, 5, 4);
            const head = new THREE.Mesh(headGeometry, bodyMaterial);
            head.position.set(0, bodyScaleY * 0.3 + neckLength, bodyScaleZ * 0.8 + headSize * 0.5);
            addVertexJitter(headGeometry);
            bird.add(head);

            // Beak (randomized size and shape)
            const beakSize = isPlayer ? 0.15 : 0.1 + Math.random() * 0.15;
            const beakLength = isPlayer ? 0.5 : 0.3 + Math.random() * 0.4;
            const beakGeometry = new THREE.ConeGeometry(beakSize, beakLength, 4);
            const beakMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xffa500,
                flatShading: true
            });
            const beak = new THREE.Mesh(beakGeometry, beakMaterial);
            beak.position.set(0, head.position.y, head.position.z + headSize * 0.8);
            beak.rotation.x = Math.PI / 2;
            addVertexJitter(beakGeometry);
            bird.add(beak);

            // Wings (randomized)
            const wingGeometry = new THREE.BoxGeometry(wingLength, wingThickness, bodyScaleZ * 0.6);
            const leftWing = new THREE.Mesh(wingGeometry, bodyMaterial);
            leftWing.position.set(-bodyScaleX * 0.8, 0, 0);
            leftWing.rotation.z = 0.3;
            addVertexJitter(wingGeometry);
            bird.add(leftWing);

            const rightWingGeometry = new THREE.BoxGeometry(wingLength, wingThickness, bodyScaleZ * 0.6);
            const rightWing = new THREE.Mesh(rightWingGeometry, bodyMaterial);
            rightWing.position.set(bodyScaleX * 0.8, 0, 0);
            rightWing.rotation.z = -0.3;
            addVertexJitter(rightWingGeometry);
            bird.add(rightWing);

            // Tail (random length)
            if (!isPlayer || Math.random() > 0.3) {
                const tailLength = isPlayer ? 0.8 : 0.5 + Math.random() * 0.8;
                const tailGeometry = new THREE.ConeGeometry(0.3, tailLength, 4);
                const tail = new THREE.Mesh(tailGeometry, bodyMaterial);
                tail.position.set(0, 0, -bodyScaleZ * 0.8);
                tail.rotation.x = -Math.PI / 2;
                addVertexJitter(tailGeometry);
                bird.add(tail);
            }

            // Some birds get extra features (not player)
            if (!isPlayer && Math.random() > 0.5) {
                // Crest/mohawk
                const crestGeometry = new THREE.ConeGeometry(0.2, 0.5, 4);
                const crest = new THREE.Mesh(crestGeometry, bodyMaterial);
                crest.position.set(0, head.position.y + headSize * 0.6, head.position.z - headSize * 0.2);
                addVertexJitter(crestGeometry);
                bird.add(crest);
            }

            bird.leftWing = leftWing;
            bird.rightWing = rightWing;
            bird.bodyScaleY = bodyScaleY;

            bird.position.set(x, y, z);
            bird.alive = true;

            return bird;
        }

        function addVertexJitter(geometry) {
            const positions = geometry.attributes.position.array;
            for (let i = 0; i < positions.length; i++) {
                positions[i] += (Math.random() - 0.5) * VERTEX_JITTER;
            }
            geometry.attributes.position.needsUpdate = true;
        }

        function updateBiome() {
            const biome = getCurrentBiome();
            
            // Update ground color
            ground.material.color.setHex(biome.ground);
            
            // Update sky and fog
            scene.background.setHex(biome.sky);
            scene.fog.color.setHex(biome.fog);
            
            // Update HUD
            document.getElementById('biomeDisplay').textContent = biome.name;
        }

        function startGame() {
            gameStarted = true;
            gameActive = true;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('customizationMenu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('levelCount').textContent = currentLevel;
            document.getElementById('birdCount').textContent = getBirdCount();
            document.getElementById('biomeDisplay').textContent = getCurrentBiome().name;
        }

        function showCustomization() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('customizationMenu').style.display = 'flex';
        }

        function setupCustomizationHandlers() {
            // Color selection
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    playerColor = parseInt(this.getAttribute('data-color'));
                });
            });

            // Shape selection
            document.querySelectorAll('.option-button').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.option-button').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    playerShape = this.getAttribute('data-shape');
                });
            });

            // Start game button
            document.getElementById('startGameButton').addEventListener('click', startGame);
        }

        function updatePlayer() {
            if (!gameActive || !player.alive) return;

            const moveVector = new THREE.Vector3();

            // WASD or Arrow keys
            if (keys['w'] || keys['arrowup']) moveVector.z -= MOVE_SPEED;
            if (keys['s'] || keys['arrowdown']) moveVector.z += MOVE_SPEED;
            if (keys['a'] || keys['arrowleft']) moveVector.x -= MOVE_SPEED;
            if (keys['d'] || keys['arrowright']) moveVector.x += MOVE_SPEED;
            if (keys[' ']) moveVector.y += MOVE_SPEED; // Space for up
            if (keys['shift']) moveVector.y -= MOVE_SPEED; // Shift for down

            player.position.add(moveVector);

            // Keep player in bounds
            player.position.x = Math.max(-40, Math.min(40, player.position.x));
            player.position.y = Math.max(-1, Math.min(15, player.position.y));
            player.position.z = Math.max(-40, Math.min(40, player.position.z));

            // Rotate player based on movement
            if (moveVector.length() > 0) {
                const angle = Math.atan2(moveVector.x, moveVector.z);
                player.rotation.y = angle;
            }

            // Wing flap animation
            const flapSpeed = 10;
            const flapAmount = 0.5;
            player.leftWing.rotation.z = 0.3 + Math.sin(Date.now() * 0.01 * flapSpeed) * flapAmount;
            player.rightWing.rotation.z = -0.3 - Math.sin(Date.now() * 0.01 * flapSpeed) * flapAmount;

            // Camera follows player
            camera.position.x = player.position.x;
            camera.position.y = player.position.y + 8;
            camera.position.z = player.position.z + 15;
            camera.lookAt(player.position);
        }

        function updateBirds() {
            if (!gameActive) return;

            birds.forEach((bird, index) => {
                if (!bird.alive) return;

                // Move bird
                bird.position.add(bird.velocity);

                // Bounce off boundaries
                if (Math.abs(bird.position.x) > 40) {
                    bird.velocity.x *= -1;
                    bird.position.x = Math.sign(bird.position.x) * 40;
                }
                if (bird.position.y < -1 || bird.position.y > 15) {
                    bird.velocity.y *= -1;
                    bird.position.y = Math.max(-1, Math.min(15, bird.position.y));
                }
                if (Math.abs(bird.position.z) > 40) {
                    bird.velocity.z *= -1;
                    bird.position.z = Math.sign(bird.position.z) * 40;
                }

                // Random direction changes and occasional player targeting
                if (Math.random() < 0.01) {
                    bird.velocity.x += (Math.random() - 0.5) * 0.02;
                    bird.velocity.z += (Math.random() - 0.5) * 0.02;
                    bird.velocity.y += (Math.random() - 0.5) * 0.01;
                }
                
                // Occasionally chase the player (increases with level)
                const chaseChance = 0.002 * currentLevel;
                if (Math.random() < chaseChance && player.alive) {
                    const toPlayer = new THREE.Vector3()
                        .subVectors(player.position, bird.position)
                        .normalize()
                        .multiplyScalar(getBirdSpeed() * 0.3);
                    bird.velocity.lerp(toPlayer, 0.1);
                }

                // Face direction of movement
                if (bird.velocity.length() > 0) {
                    const angle = Math.atan2(bird.velocity.x, bird.velocity.z);
                    bird.rotation.y = angle;
                }

                // Wing flap
                const flapSpeed = 8;
                const flapAmount = 0.4;
                bird.leftWing.rotation.z = 0.3 + Math.sin(Date.now() * 0.01 * flapSpeed + index) * flapAmount;
                bird.rightWing.rotation.z = -0.3 - Math.sin(Date.now() * 0.01 * flapSpeed + index) * flapAmount;

                // Check collision with player
                if (player.alive) {
                    const distance = bird.position.distanceTo(player.position);
                    if (distance < COLLISION_DISTANCE) {
                        // Determine who hit whom based on velocity direction
                        const toBird = new THREE.Vector3().subVectors(bird.position, player.position).normalize();
                        const playerVelocity = new THREE.Vector3();
                        
                        // Calculate player's current velocity from input
                        if (keys['w'] || keys['arrowup']) playerVelocity.z -= MOVE_SPEED;
                        if (keys['s'] || keys['arrowdown']) playerVelocity.z += MOVE_SPEED;
                        if (keys['a'] || keys['arrowleft']) playerVelocity.x -= MOVE_SPEED;
                        if (keys['d'] || keys['arrowright']) playerVelocity.x += MOVE_SPEED;
                        if (keys[' ']) playerVelocity.y += MOVE_SPEED;
                        if (keys['shift']) playerVelocity.y -= MOVE_SPEED;
                        
                        // Check if player is moving toward bird
                        const playerMovingToBird = playerVelocity.length() > 0 && playerVelocity.normalize().dot(toBird) > 0.3;
                        
                        // Check if bird is moving toward player
                        const toPlayer = toBird.clone().negate();
                        const birdMovingToPlayer = bird.velocity.clone().normalize().dot(toPlayer) > 0.3;
                        
                        if (playerMovingToBird && !birdMovingToPlayer) {
                            // Player hit the bird - bird dies
                            killBird(bird);
                        } else if (birdMovingToPlayer) {
                            // Bird hit the player - player dies
                            killBird(bird);
                            killBird(player);
                            gameOver();
                        } else {
                            // Ambiguous collision - both die
                            killBird(bird);
                            killBird(player);
                            gameOver();
                        }
                    }
                }

                // Check collision with other birds
                birds.forEach((otherBird, otherIndex) => {
                    if (otherIndex <= index || !otherBird.alive) return;
                    const distance = bird.position.distanceTo(otherBird.position);
                    if (distance < COLLISION_DISTANCE) {
                        killBird(bird);
                        killBird(otherBird);
                    }
                });
            });

            // Update bird count
            const aliveBirds = birds.filter(b => b.alive).length;
            document.getElementById('birdCount').textContent = aliveBirds;
            
            // Check for victory
            if (aliveBirds === 0 && player.alive && gameActive) {
                victory();
            }
        }

        function killBird(bird) {
            if (!bird.alive) return;
            bird.alive = false;
            
            // Death animation - fall and fade
            const deathTween = () => {
                if (bird.position.y > -5) {
                    bird.position.y -= 0.1;
                    bird.rotation.x += 0.1;
                    bird.rotation.z += 0.05;
                    requestAnimationFrame(deathTween);
                } else {
                    scene.remove(bird);
                }
            };
            deathTween();
        }

        function gameOver() {
            gameActive = false;
            document.getElementById('status').textContent = 'DEAD';
            document.getElementById('status').style.color = '#ff0000';
            document.getElementById('gameOver').style.display = 'block';
        }

        function victory() {
            gameActive = false;
            document.getElementById('status').textContent = 'VICTORIOUS';
            document.getElementById('status').style.color = '#ffd700';
            document.getElementById('victoryScreen').style.display = 'block';
        }

        function nextLevel() {
            currentLevel++;
            document.getElementById('victoryScreen').style.display = 'none';
            
            // Update biome for new level
            updateBiome();
            
            // Remove all old birds (but not the player)
            birds.forEach(bird => scene.remove(bird));
            birds = [];
            
            // Reset player position and status
            player.position.set(0, 0, 0);
            player.alive = true;
            
            // Player keeps their color and shape through levels
            
            // Create new birds for next level
            const birdCount = getBirdCount();
            for (let i = 0; i < birdCount; i++) {
                const x = (Math.random() - 0.5) * 40;
                const y = Math.random() * 10 - 2;
                const z = (Math.random() - 0.5) * 40;
                
                const colors = [
                    0x0000ff, 0x00ffff, 0x00ff00, 0xffff00, 
                    0xff00ff, 0xff8800, 0x8800ff, 0x00ff88
                ];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                const bird = createBird(color, x, y, z, false);
                const speed = getBirdSpeed();
                bird.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * speed,
                    (Math.random() - 0.5) * speed * 0.5,
                    (Math.random() - 0.5) * speed
                );
                birds.push(bird);
                scene.add(bird);
            }
            
            // Update HUD
            gameActive = true;
            document.getElementById('levelCount').textContent = currentLevel;
            document.getElementById('birdCount').textContent = birdCount;
            document.getElementById('status').textContent = 'FLYING';
            document.getElementById('status').style.color = '#fff';
        }

        function restartGame() {
            // Remove all birds
            birds.forEach(bird => scene.remove(bird));
            scene.remove(player);
            
            birds = [];
            gameActive = true;
            gameStarted = true;
            currentLevel = 1;
            
            // Reset biome to level 1
            updateBiome();
            
            // Recreate player
            player = createBird(playerColor, 0, 0, 0, true);
            player.isPlayer = true;
            scene.add(player);
            
            // Recreate AI birds
            const birdCount = getBirdCount();
            for (let i = 0; i < birdCount; i++) {
                const x = (Math.random() - 0.5) * 40;
                const y = Math.random() * 10 - 2;
                const z = (Math.random() - 0.5) * 40;
                
                const colors = [
                    0x0000ff, 0x00ffff, 0x00ff00, 0xffff00, 
                    0xff00ff, 0xff8800, 0x8800ff, 0x00ff88
                ];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                const bird = createBird(color, x, y, z, false);
                const speed = getBirdSpeed();
                bird.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * speed,
                    (Math.random() - 0.5) * speed * 0.5,
                    (Math.random() - 0.5) * speed
                );
                birds.push(bird);
                scene.add(bird);
            }
            
            document.getElementById('status').textContent = 'FLYING';
            document.getElementById('status').style.color = '#fff';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('levelCount').textContent = currentLevel;
            document.getElementById('birdCount').textContent = birdCount;
        }

        function animate(displayCanvas, ctx) {
            requestAnimationFrame(() => animate(displayCanvas, ctx));

            updatePlayer();
            updateBirds();

            // Render at low resolution
            renderer.render(scene, camera);
            
            // Copy to display canvas with pixelation
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(
                renderer.domElement,
                0, 0, renderer.domElement.width, renderer.domElement.height,
                0, 0, displayCanvas.width, displayCanvas.height
            );
        }

        function onWindowResize() {
            const width = Math.floor(window.innerWidth * RENDER_SCALE);
            const height = Math.floor(window.innerHeight * RENDER_SCALE);
            
            renderer.setSize(width, height, false);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            
            const displayCanvas = document.getElementById('gameCanvas');
            displayCanvas.width = window.innerWidth;
            displayCanvas.height = window.innerHeight;
        }

        // Start the game
        init();
    </script>
</body>
</html>
